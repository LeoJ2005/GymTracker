// --- TRANSLATIONS PRESETS ---
const translations = {
    es: {
        title: "Gym Tracker",
        newExerciseBtn: "Nuevo Ejercicio",
        modalNewTitle: "Nuevo Ejercicio",
        placeholderName: "Nombre (ej. Press Banca)",
        createBtn: "Crear Ejercicio",
        modalEditTitle: "Editar Nombre",
        placeholderEdit: "Nuevo nombre",
        saveChangesBtn: "Guardar",
        modalDeleteTitle: "Â¿Eliminar Ejercicio?",
        deleteWarning: "Esta acciÃ³n no se puede deshacer. Se borrarÃ¡ todo el historial.",
        cancelBtn: "Cancelar",
        deleteBtn: "Eliminar",
        registerTitle: "Registrar",
        placeholderWeight: "100 kg",
        placeholderReps: "12 reps",
        saveRecordBtn: "Guardar",
        historyTitle: "Historial",
        progressTitle: "Progreso",
        noExercises: "No hay ejercicios registrados. Â¡Agrega uno nuevo!",
        lastRecord: "Ãšltimo:",
        noRecords: "Sin registros",
        // New
        greetingHi: "Hola",
        todayIs: "Hoy toca:",
        restDay: "Â¡DÃ­a de Descanso! ðŸ˜´",
        restMessage: "RecupÃ©rate para la prÃ³xima sesiÃ³n.",
        settingsTitle: "ConfiguraciÃ³n",
        userTab: "Usuario",
        langTab: "Idioma",
        planTab: "PlanificaciÃ³n",
        saveProfile: "Guardar Perfil",
        savePlan: "Guardar Plan",
        otherRecs: "Otros Ejercicios",
        // Muscles/Types
        chest: "Pecho", back: "Espalda", legs: "Pierna", shoulders: "Hombro", arms: "Brazo", abs: "Abdominales", 
        free: "Peso Libre", machine: "MÃ¡quina", cable: "Polea", bodyweight: "Peso Corporal", other: "Otro",
        muscleGroupPlaceholder: "Grupo Muscular", weightTypePlaceholder: "Tipo de Peso",
        // Days
        mon: "Lunes", tue: "Martes", wed: "MiÃ©rcoles", thu: "Jueves", fri: "Viernes", sat: "SÃ¡bado", sun: "Domingo",
        rest: "Descanso"
    },
    en: {
        title: "Gym Tracker",
        newExerciseBtn: "New Exercise",
        modalNewTitle: "New Exercise",
        placeholderName: "Name (e.g. Bench Press)",
        createBtn: "Create Exercise",
        modalEditTitle: "Edit Name",
        placeholderEdit: "New name",
        saveChangesBtn: "Save",
        modalDeleteTitle: "Delete Exercise?",
        deleteWarning: "This action cannot be undone. All history will be deleted.",
        cancelBtn: "Cancel",
        deleteBtn: "Delete",
        registerTitle: "Register",
        placeholderWeight: "220 lbs",
        placeholderReps: "12 reps",
        saveRecordBtn: "Save",
        historyTitle: "History",
        progressTitle: "Progress",
        noExercises: "No exercises registered. Add a new one!",
        lastRecord: "Last:",
        noRecords: "No records",
        greetingHi: "Hi",
        todayIs: "Today's Focus:",
        restDay: "Rest Day! ðŸ˜´",
        restMessage: "Recover for the next session.",
        settingsTitle: "Settings",
        userTab: "User",
        langTab: "Language",
        planTab: "Planning",
        saveProfile: "Save Profile",
        savePlan: "Save Plan",
        otherRecs: "Other Exercises",
        chest: "Chest", back: "Back", legs: "Legs", shoulders: "Shoulders", arms: "Arms", abs: "Abs", 
        free: "Free Weight", machine: "Machine", cable: "Cable", bodyweight: "Bodyweight", other: "Other",
        muscleGroupPlaceholder: "Muscle Group", weightTypePlaceholder: "Weight Type",
        mon: "Monday", tue: "Tuesday", wed: "Wednesday", thu: "Thursday", fri: "Friday", sat: "Saturday", sun: "Sunday",
        rest: "Rest"
    },
    fr: {
        title: "Gym Tracker", newExerciseBtn: "Nouvel Exercice", modalNewTitle: "Nouvel Exercice",
        placeholderName: "Nom (ex. DÃ©veloppÃ© CouchÃ©)", createBtn: "CrÃ©er",
        modalEditTitle: "Modifier le Nom", placeholderEdit: "Nouveau nom", saveChangesBtn: "Enregistrer",
        modalDeleteTitle: "Supprimer l'Exercice ?", deleteWarning: "Cette action est irrÃ©versible.",
        cancelBtn: "Annuler", deleteBtn: "Supprimer",
        registerTitle: "Enregistrer", placeholderWeight: "100 kg", placeholderReps: "12 reps", saveRecordBtn: "Enregistrer",
        historyTitle: "Historique", progressTitle: "ProgrÃ¨s", noExercises: "Aucun exercice.", lastRecord: "Dernier:", noRecords: "Aucun enregistrement",
        greetingHi: "Salut", todayIs: "Aujourd'hui:", restDay: "Repos!", restMessage: "RÃ©cupÃ©ration.",
        settingsTitle: "ParamÃ¨tres", userTab: "Utilisateur", langTab: "Langue", planTab: "Planification",
        saveProfile: "Sauvegarder", savePlan: "Sauvegarder", otherRecs: "Autres",
        chest: "Poitrine", back: "Dos", legs: "Jambes", shoulders: "Ã‰paules", arms: "Bras", abs: "Abdos", 
        free: "Poids Libre", machine: "Machine", cable: "CÃ¢ble", bodyweight: "Poids du Corps", other: "Autre",
        muscleGroupPlaceholder: "Groupe Musculaire", weightTypePlaceholder: "Type de Poids",
        mon: "Lundi", tue: "Mardi", wed: "Mercredi", thu: "Jeudi", fri: "Vendredi", sat: "Samedi", sun: "Dimanche", rest: "Repos"
    },
    de: {
        title: "Gym Tracker", newExerciseBtn: "Neue Ãœbung", modalNewTitle: "Neue Ãœbung",
        placeholderName: "Name (z.B. BankdrÃ¼cken)", createBtn: "Erstellen",
        modalEditTitle: "Name Bearbeiten", placeholderEdit: "Neuer Name", saveChangesBtn: "Speichern",
        modalDeleteTitle: "Ãœbung lÃ¶schen?", deleteWarning: "Diese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden.",
        cancelBtn: "Abbrechen", deleteBtn: "LÃ¶schen",
        registerTitle: "Registrieren", placeholderWeight: "100 kg", placeholderReps: "12 reps", saveRecordBtn: "Speichern",
        historyTitle: "Verlauf", progressTitle: "Fortschritt", noExercises: "Keine Ãœbungen.", lastRecord: "Zuletzt:", noRecords: "Keine EintrÃ¤ge",
        greetingHi: "Hallo", todayIs: "Heute:", restDay: "Ruhetag!", restMessage: "Erholung.",
        settingsTitle: "Einstellungen", userTab: "Benutzer", langTab: "Sprache", planTab: "Planung",
        saveProfile: "Speichern", savePlan: "Speichern", otherRecs: "Andere",
        chest: "Brust", back: "RÃ¼cken", legs: "Beine", shoulders: "Schultern", arms: "Arme", abs: "Bauch", 
        free: "Freies Gewicht", machine: "Maschine", cable: "Kabelzug", bodyweight: "KÃ¶rpergewicht", other: "Andere",
        muscleGroupPlaceholder: "Muskelgruppe", weightTypePlaceholder: "Gewichtsart",
        mon: "Montag", tue: "Dienstag", wed: "Mittwoch", thu: "Donnerstag", fri: "Freitag", sat: "Samstag", sun: "Sonntag", rest: "Ruhe"
    },
    zh: {
        title: "å¥èº«è¿½è¸ªå™¨", newExerciseBtn: "æ–°ç»ƒä¹ ", modalNewTitle: "æ–°ç»ƒä¹ ",
        placeholderName: "åç§° (ä¾‹å¦‚ å§æŽ¨)", createBtn: "åˆ›å»º",
        modalEditTitle: "ç¼–è¾‘åç§°", placeholderEdit: "æ–°åç§°", saveChangesBtn: "ä¿å­˜",
        modalDeleteTitle: "åˆ é™¤ç»ƒä¹ ï¼Ÿ", deleteWarning: "æ­¤æ“ä½œæ— æ³•æ’¤æ¶ˆã€‚",
        cancelBtn: "å–æ¶ˆ", deleteBtn: "åˆ é™¤",
        registerTitle: "æ³¨å†Œ", placeholderWeight: "100 kg", placeholderReps: "12 reps", saveRecordBtn: "ä¿å­˜",
        historyTitle: "åŽ†å²", progressTitle: "è¿›åº¦", noExercises: "æ²¡æœ‰è¿åŠ¨.", lastRecord: "æœ€åŽ:", noRecords: "æ— è®°å½•",
        greetingHi: "ä½ å¥½", todayIs: "ä»Šå¤©:", restDay: "ä¼‘æ¯æ—¥!", restMessage: "æ¢å¤.",
        settingsTitle: "è®¾ç½®", userTab: "ç”¨æˆ·", langTab: "è¯­è¨€", planTab: "è®¡åˆ’",
        saveProfile: "ä¿å­˜", savePlan: "ä¿å­˜", otherRecs: "å…¶ä»–",
        chest: "èƒ¸éƒ¨", back: "èƒŒéƒ¨", legs: "è…¿éƒ¨", shoulders: "è‚©éƒ¨", arms: "æ‰‹è‡‚", abs: "è…¹è‚Œ", 
        free: "è‡ªç”±é‡é‡", machine: "æœºå™¨", cable: "ç»³ç´¢", bodyweight: "è‡ªé‡", other: "å…¶ä»–",
        muscleGroupPlaceholder: "è‚Œç¾¤", weightTypePlaceholder: "é‡é‡ç±»åž‹",
        mon: "æ˜ŸæœŸä¸€", tue: "æ˜ŸæœŸäºŒ", wed: "æ˜ŸæœŸä¸‰", thu: "æ˜ŸæœŸå››", fri: "æ˜ŸæœŸäº”", sat: "æ˜ŸæœŸå…­", sun: "æ˜ŸæœŸæ—¥", rest: "ä¼‘æ¯"
    }
};

// --- APP STATE ---

let exercises = [];
let currentExerciseId = null;
let currentLang = localStorage.getItem('gymTrackerLang') || 'es';
let weightChart = null;
let deleteIdTarget = null;

let userProfile = {
    name: '',
    lastname: '',
    address: '',
    plan: {
        mon: [], tue: [], wed: [], thu: [], fri: [], sat: [], sun: []
    }
};

const daysOrder = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
const muscleGroups = ['chest', 'back', 'legs', 'shoulders', 'arms', 'abs', 'rest'];

// --- DOM ELEMENTS ---
// (Will be fetched in setup)

function t(key) {
    const tr = translations[currentLang] || translations['es'];
    return tr[key] || translations['es'][key] || key;
}

// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
    loadSettings();
    loadExercises();
    applyTranslations();
    setupEventListeners();
    renderPlanning(); // Populate settings grid
    updateGreetingAndGrid(); // Show dashboard
});


// --- DATA LOGIC ---

function loadSettings() {
    // Lang
    currentLang = localStorage.getItem('gymTrackerLang') || 'es';
    
    // User
    const storedUser = localStorage.getItem('gymTrackerUser');
    if (storedUser) {
        try { userProfile = JSON.parse(storedUser); } catch(e) {}
    }
    // Fill forms
    document.getElementById('user-name').value = userProfile.name || '';
    document.getElementById('user-lastname').value = userProfile.lastname || '';
    document.getElementById('user-address').value = userProfile.address || '';
}

function saveUserProfile() {
    userProfile.name = document.getElementById('user-name').value;
    userProfile.lastname = document.getElementById('user-lastname').value;
    userProfile.address = document.getElementById('user-address').value;
    
    // Plan is saved separately or together? Together usually easier.
    localStorage.setItem('gymTrackerUser', JSON.stringify(userProfile));
    updateGreetingAndGrid(); // Refresh dashboard
}

function loadExercises() {
    const stored = localStorage.getItem('gymTrackerData');
    if (stored) {
        try { exercises = JSON.parse(stored); } catch (e) { exercises = []; }
    }
    // Ensure migration
    exercises.forEach(ex => {
        if (!ex.muscleGroup) ex.muscleGroup = 'other';
        if (!ex.weightType) ex.weightType = 'other';
    });
}

function saveExercises() {
    localStorage.setItem('gymTrackerData', JSON.stringify(exercises));
    updateGreetingAndGrid();
}

function addNewExercise(name, muscle, type) {
    const newEx = {
        id: Date.now().toString(),
        name: name,
        muscleGroup: muscle || 'other',
        weightType: type || 'other',
        history: []
    };
    exercises.push(newEx);
    saveExercises();
}


// --- RENDERING ---

function applyTranslations() {
    const tr = translations[currentLang] || translations['es'];
    
    // Header
    document.querySelector('header h1').innerHTML = `<i class="ph-fill ph-barbell"></i> ${tr.title}`;
    const btnAddHead = document.getElementById('btn-add-exercise');
    if(btnAddHead) btnAddHead.innerHTML = `<i class="ph-bold ph-plus"></i> ${tr.newExerciseBtn}`;
    
    // Settings Modal
    const settingsH2 = document.querySelector('#modal-settings h2');
    if(settingsH2) settingsH2.innerHTML = `<i class="ph-duotone ph-gear"></i> ${tr.settingsTitle}`;
    
    const tabUser = document.querySelector('[data-tab="user"]');
    if(tabUser) tabUser.textContent = tr.userTab;
    const tabLang = document.querySelector('[data-tab="lang"]');
    if(tabLang) tabLang.textContent = tr.langTab;
    const tabPlan = document.querySelector('[data-tab="plan"]');
    if(tabPlan) tabPlan.textContent = tr.planTab;
    
    const btnSaveProfile = document.querySelector('#form-user-profile button');
    if(btnSaveProfile) btnSaveProfile.textContent = tr.saveProfile;
    const btnSavePlan = document.getElementById('btn-save-plan');
    if(btnSavePlan) btnSavePlan.textContent = tr.savePlan;

    // New Exercise Modal
    const titleNew = document.getElementById('title-new-exercise');
    if(titleNew) titleNew.innerHTML = `<i class="ph-duotone ph-plus-circle"></i> ${tr.modalNewTitle}`;
    
    const inputName = document.getElementById('input-exercise-name');
    if(inputName) inputName.placeholder = tr.placeholderName;
    
    const btnCreate = document.getElementById('btn-create-exercise');
    if(btnCreate) btnCreate.textContent = tr.createBtn;

    // Update Select Options (Muscle/Type) in New Exercise
    const muscleSelect = document.getElementById('input-muscle-group');
    if(muscleSelect) {
        if(muscleSelect.options[0]) muscleSelect.options[0].text = tr.muscleGroupPlaceholder;
        Array.from(muscleSelect.options).forEach(opt => {
            if(opt.value && tr[opt.value]) opt.text = tr[opt.value];
        });
    }
    const typeSelect = document.getElementById('input-weight-type');
    if(typeSelect) {
        if(typeSelect.options[0]) typeSelect.options[0].text = tr.weightTypePlaceholder;
        Array.from(typeSelect.options).forEach(opt => {
            if(opt.value && tr[opt.value]) opt.text = tr[opt.value];
        });
    }

    // Edit Modal
    const titleEdit = document.getElementById('title-edit-exercise');
    if(titleEdit) titleEdit.innerHTML = `<i class="ph-duotone ph-pencil-simple"></i> ${tr.modalEditTitle}`;
    
    const inputEdit = document.getElementById('input-edit-name');
    if(inputEdit) inputEdit.placeholder = tr.placeholderEdit;
    
    const btnSaveEdit = document.getElementById('btn-save-edit');
    if(btnSaveEdit) btnSaveEdit.textContent = tr.saveChangesBtn;
    
    const btnCancelEdit = document.getElementById('btn-cancel-edit');
    if(btnCancelEdit) btnCancelEdit.textContent = tr.cancelBtn;

    // Delete Modal
    const modalDelete = document.getElementById('modal-delete-confirm');
    if(modalDelete) {
        document.getElementById('title-delete-modal').innerHTML = `<i class="ph-duotone ph-warning"></i> ${tr.modalDeleteTitle}`;
        document.getElementById('text-delete-warning').textContent = tr.deleteWarning;
        document.getElementById('btn-cancel-delete').textContent = tr.cancelBtn;
        document.getElementById('btn-confirm-delete').textContent = tr.deleteBtn;
    }

    // Details Modal (Headers)
    const modalDetails = document.getElementById('modal-details');
    if(modalDetails) {
        document.getElementById('title-register').innerHTML = `<i class="ph-duotone ph-pencil-simple"></i> ${tr.registerTitle}`;
        document.getElementById('title-history').innerHTML = `<i class="ph-duotone ph-clock-counter-clockwise"></i> ${tr.historyTitle}`;
        document.getElementById('title-progress').innerHTML = `<i class="ph-bold ph-chart-line-up"></i> ${tr.progressTitle}`;
        
        document.getElementById('input-weight').placeholder = tr.placeholderWeight;
        document.getElementById('input-reps').placeholder = tr.placeholderReps;
        
        const btnSaveRecord = document.querySelector('#form-add-weight button');
        if(btnSaveRecord) btnSaveRecord.innerHTML = `<i class="ph-bold ph-check"></i> ${tr.saveRecordBtn}`;
    }

    // Refresh Grid titles
    updateGreetingAndGrid();
}

function renderPlanning() {
    const grid = document.getElementById('planning-grid');
    grid.innerHTML = '';
    
    daysOrder.forEach(day => {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'plan-day';
        
        const title = document.createElement('h4');
        title.textContent = t(day);
        dayDiv.appendChild(title);
        
        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'muscle-options';
        
        muscleGroups.forEach(muscle => {
            const label = document.createElement('label');
            label.className = 'muscle-checkbox';
            
            const isChecked = userProfile.plan[day] && userProfile.plan[day].includes(muscle);
            if(isChecked) label.classList.add('checked');
            
            label.innerHTML = `
                <input type="checkbox" value="${muscle}" ${isChecked ? 'checked' : ''}>
                ${t(muscle)}
            `;
            
            // Toggle Logic
            label.querySelector('input').addEventListener('change', (e) => {
                if(e.target.checked) label.classList.add('checked');
                else label.classList.remove('checked');
            });
            
            optionsDiv.appendChild(label);
        });
        
        dayDiv.appendChild(optionsDiv);
        grid.appendChild(dayDiv);
    });
}

function savePlanningFromUI() {
    const grid = document.getElementById('planning-grid');
    const dayDivs = grid.querySelectorAll('.plan-day');
    
    // Reset plan
    userProfile.plan = { mon: [], tue: [], wed: [], thu: [], fri: [], sat: [], sun: [] };
    
    dayDivs.forEach((div, index) => {
        const dayKey = daysOrder[index];
        const checked = div.querySelectorAll('input:checked');
        checked.forEach(cb => {
            userProfile.plan[dayKey].push(cb.value);
        });
    });
    
    saveUserProfile(); // Saves userProfile to localstorage
}

function updateGreetingAndGrid() {
    // 1. Determine Today
    const todayIndex = new Date().getDay(); // 0 = Sun
    // Map to keys. 0->sun, 1->mon
    const dayMap = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
    const todayKey = dayMap[todayIndex];
    
    const name = userProfile.name || 'Atleta';
    const planToday = userProfile.plan[todayKey] || [];
    
    const isRest = planToday.includes('rest') || planToday.length === 0;
    
    // 2. Render Greeting
    const greetingDiv = document.getElementById('dashboard-greeting');
    if (greetingDiv) {
        greetingDiv.style.display = 'block';
        let subMsg = '';
        if (isRest) {
            subMsg = `<span class="greeting-highlight">${t('restDay')}</span> <br> ${t('restMessage')}`;
        } else {
            const musclesText = planToday.map(m => t(m)).join(', ');
            subMsg = `${t('todayIs')} <span class="greeting-highlight">${musclesText}</span>`;
        }
        
        greetingDiv.innerHTML = `
            <div class="greeting-title">${t('greetingHi')}, ${name} ðŸ‘‹</div>
            <div class="greeting-subtitle">${subMsg}</div>
        `;
    }
    
    // 3. Render Grid (Filtered)
    renderFilteredGrid(planToday, isRest);
}

function renderFilteredGrid(planToday, isRest) {
    const container = document.getElementById('exercises-grid');
    if (!container) return;
    container.innerHTML = '';
    
    if (exercises.length === 0) {
        container.innerHTML = `<p style="grid-column: 1/-1; text-align: center; color: var(--text-secondary);">${t('noExercises')}</p>`;
        return;
    }

    // Split exercises
    let priority = [];
    let others = [];
    
    if (isRest) {
        others = [...exercises];
    } else {
        exercises.forEach(ex => {
            // Check match
            if (planToday.includes(ex.muscleGroup)) {
                priority.push(ex);
            } else {
                others.push(ex);
            }
        });
    }
    
    // Render Priority
    if (priority.length > 0) {
        priority.forEach(ex => container.appendChild(createCard(ex)));
    }
    
    // Divider
    if (priority.length > 0 && others.length > 0) {
        const divider = document.createElement('div');
        divider.className = 'section-divider';
        divider.style.gridColumn = "1 / -1";
        container.appendChild(divider);
    }
    
    // Render Others
    others.forEach(ex => container.appendChild(createCard(ex)));
}

function createCard(ex) {
    const lastRecord = ex.history.length > 0 ? ex.history[ex.history.length - 1] : null;
        
    const card = document.createElement('div');
    card.className = 'exercise-card';
    card.onclick = () => openDetails(ex.id);
    
    // Helper translation for muscle
    const mLabel = TRANSLATE_MUSCLE_LABEL(ex.muscleGroup);

    card.innerHTML = `
        <div class="card-header">
            <span class="exercise-name">${ex.name}</span>
            <i class="ph-duotone ph-caret-right" style="color:var(--text-secondary)"></i>
        </div>
        <div style="font-size: 0.8rem; color: var(--accent-color); margin-bottom: 0.5rem; text-transform: uppercase; font-weight: bold;">
            ${mLabel}
        </div>
        <div class="last-weight">
            <i class="ph ph-barbell"></i> <span>${lastRecord ? `${lastRecord.weight} kg <span style="font-size:0.8em; color:var(--text-secondary)">x ${lastRecord.reps || 0}</span>` : '-'}</span>
        </div>
        <div class="last-weight" style="margin-top: 0.5rem; font-size: 0.8rem;">
            <i class="ph ph-calendar-blank"></i> ${lastRecord ? formatDate(lastRecord.date) : t('noRecords')}
        </div>
    `;
    return card;
}

function TRANSLATE_MUSCLE_LABEL(key) {
    if (!key || key === 'other') return '';
    return t(key);
}

// --- STANDARD MODAL/CRUD LOGIC (Existing but updated) ---

function openDetails(id) {
    currentExerciseId = id;
    const exercise = exercises.find(e => e.id === id);
    if (!exercise) return;

    const titleEl = document.getElementById('details-title');
    if(titleEl) titleEl.textContent = exercise.name;
    
    const historySorted = [...exercise.history].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
    renderHistory(historySorted);
    renderChart(exercise.history);
    
    openModal(document.getElementById('modal-details'));
}

function renderHistory(historySorted) {
    const list = document.getElementById('weight-history-list');
    if (!list) return;
    list.innerHTML = '';
    if (historySorted.length === 0) {
        list.innerHTML = `<li class="history-item" style="justify-content: center; color: var(--text-secondary);">${t('noRecords')}</li>`;
        return;
    }
    historySorted.forEach(record => {
        const li = document.createElement('li');
        li.className = 'history-item';
        li.innerHTML = `
            <span class="history-date"><i class="ph ph-calendar-blank"></i> ${formatDate(record.date)}</span>
            <span class="history-weight">
                ${record.weight} kg <span style="font-size:0.8em; color:var(--text-secondary);">x ${record.reps || 0} reps</span>
            </span>
        `;
        list.appendChild(li);
    });
}

function addWeightRecord(id, w, r, date) {
    const ex = exercises.find(e => e.id === id);
    if (ex) {
        ex.history.push({ weight: w, reps: r, date: date });
        ex.history.sort((a, b) => new Date(a.date) - new Date(b.date));
        saveExercises();
        if (currentExerciseId === id) openDetails(id);
    }
}

function deleteExercise(id) {
    exercises = exercises.filter(e => e.id !== id);
    saveExercises();
}

function updateExerciseName(id, name) {
    const ex = exercises.find(e => e.id === id);
    if (ex) { ex.name = name; saveExercises(); }
}

function setupEventListeners() {
    // Settings Button
    const btnSettings = document.getElementById('btn-open-settings');
    const modalSettings = document.getElementById('modal-settings');
    if (btnSettings) {
        btnSettings.onclick = () => openModal(modalSettings);
    }
    const closeSettings = document.getElementById('close-settings');
    if(closeSettings) closeSettings.onclick = () => closeModal(modalSettings);
    
    // Settings Tabs
    const tabs = document.querySelectorAll('.settings-nav-item');
    tabs.forEach(tab => {
        tab.onclick = () => {
            // Remove active
            document.querySelectorAll('.settings-nav-item').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            
            // Add active
            tab.classList.add('active');
            const target = tab.getAttribute('data-tab');
            document.getElementById(`tab-${target}`).classList.add('active');
        };
    });
    
    // Language Buttons in Settings
    const langBtns = document.querySelectorAll('.lang-select-btn');
    langBtns.forEach(btn => {
        btn.onclick = () => {
            const l = btn.getAttribute('data-lang');
            setLanguage(l);
        };
    });
    
    // Forms
    document.getElementById('form-user-profile').onsubmit = (e) => {
        e.preventDefault();
        saveUserProfile();
        alert('Perfil guardado');
    };
    
    document.getElementById('btn-save-plan').onclick = () => {
        savePlanningFromUI();
        alert('PlanificaciÃ³n guardada');
    };

    // New Exercise
    const formNew = document.getElementById('form-new-exercise');
    formNew.onsubmit = (e) => {
        e.preventDefault();
        const outputName = document.getElementById('input-exercise-name').value.trim();
        const outputMuscle = document.getElementById('input-muscle-group').value;
        const outputType = document.getElementById('input-weight-type').value;
        
        if (outputName) {
            addNewExercise(outputName, outputMuscle, outputType);
            closeModal(document.getElementById('modal-new-exercise'));
            formNew.reset();
        }
    };
    
    // Add Weight
    const formAdd = document.getElementById('form-add-weight');
    formAdd.onsubmit = (e) => {
        e.preventDefault();
        const w = parseFloat(document.getElementById('input-weight').value);
        const r = parseInt(document.getElementById('input-reps').value);
        if(!isNaN(w) && !isNaN(r) && currentExerciseId) {
            addWeightRecord(currentExerciseId, w, r, new Date().toISOString());
            formAdd.reset(); // Nice UX
        }
    };

    // Edit/Delete
    const btnEdit = document.getElementById('btn-edit-exercise');
    const btnDel = document.getElementById('btn-delete-exercise');
    const btnConfirmDel = document.getElementById('btn-confirm-delete');
    const btnCancelDel = document.getElementById('btn-cancel-delete');
    
    if(btnEdit) btnEdit.onclick = () => {
        const ex = exercises.find(e => e.id === currentExerciseId);
        if(ex) {
            document.getElementById('input-edit-name').value = ex.name;
            openModal(document.getElementById('modal-edit-exercise'));
        }
    };
    
    if(btnDel) btnDel.onclick = () => {
        deleteIdTarget = currentExerciseId;
        openModal(document.getElementById('modal-delete-confirm'));
    };
    
    if(btnConfirmDel) btnConfirmDel.onclick = () => {
        if(deleteIdTarget) deleteExercise(deleteIdTarget);
        closeModal(document.getElementById('modal-delete-confirm'));
        closeModal(document.getElementById('modal-details'));
    };
    
    if(btnCancelDel) btnCancelDel.onclick = () => closeModal(document.getElementById('modal-delete-confirm'));
    
    const btnCancelEdit = document.getElementById('btn-cancel-edit');
    if(btnCancelEdit) btnCancelEdit.onclick = () => closeModal(document.getElementById('modal-edit-exercise'));
    
    const formEdit = document.getElementById('form-edit-exercise');
    formEdit.onsubmit = (e) => {
        e.preventDefault();
        const input = document.getElementById('input-edit-name');
        if(input.value.trim() && currentExerciseId) {
            updateExerciseName(currentExerciseId, input.value.trim());
            document.getElementById('details-title').textContent = input.value.trim();
            closeModal(document.getElementById('modal-edit-exercise'));
        }
    };
    
    // Modals generic
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', (e) => {
            // Find parent modal
            const modal = btn.closest('.modal');
            closeModal(modal);
        });
    });
    
    const btnAddMain = document.getElementById('btn-add-exercise');
    if(btnAddMain) btnAddMain.onclick = () => openModal(document.getElementById('modal-new-exercise'));

    window.onclick = (e) => {
        if(e.target.classList.contains('modal')) closeModal(e.target);
    };
}

function setLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('gymTrackerLang', lang);
    applyTranslations();
    renderPlanning(); // Re-render checkbox labels
    updateGreetingAndGrid(); // Re-render greeting
}

function openModal(m) { if(m) m.classList.add('show'); }
function closeModal(m) { if(m) m.classList.remove('show'); }

function renderChart(history) {
    if (typeof Chart === 'undefined') return;
    const canvas = document.getElementById('weightChart');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    if (weightChart) weightChart.destroy();
    
    const h = [...history].sort((a, b) => new Date(a.date) - new Date(b.date));
    weightChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: h.map(x => formatDate(x.date)),
            datasets: [{
                label: 'Weight',
                data: h.map(x => x.weight),
                borderColor: '#FFD000',
                backgroundColor: 'rgba(255, 208, 0, 0.1)',
                borderWidth: 2,
                pointRadius: 4,
                pointBackgroundColor: '#FFD000',
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }, // Simple
            scales: {
                x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#888' } },
                y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#888' } }
            }
        }
    });
}

function formatDate(d) {
    return new Date(d).toLocaleDateString(currentLang === 'es' ? 'es-ES' : 'en-US', { day: 'numeric', month: 'short' });
}
